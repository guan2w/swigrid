# Schulte Grid iOS 原生重写 - 当前开发进度

## 1. 文档目的

本文件是开发状态基线与交接基线。

- 清空对话上下文后，从本文件恢复工作。
- 每次开发结束必须更新。
- 只记录当前事实状态；长期规则请回写到 `01~03`。

## 1.1 恢复工作步骤（下次从零开始）

1. 先读 `docs/01~03`，再读本文件最新一条变更日志。
2. 以“最新一条”的“下一步”作为默认起点执行。
3. 执行前确认门禁脚本与目标分支状态，避免跨轮次脏状态干扰。
4. 完成后将本轮验证命令、结果与遗留风险追加到本文件。

## 2. 当前基线（截至 2026-02-19）

### 2.1 已完成

- 业务模块：`SchulteDomain`、`SchulteData`、`SchulteFeatures`、`SchulteAppUI`。
- 壳工程：`swigrid.xcodeproj` 接入本地 Swift Package。
- 目标平台：`iOS 26+`，`iPhone/iPad`，仅竖屏。
- 核心流程：`Home -> Game -> Result -> Records` 可运行。
- 规则能力：计分、星级、记录排序、静音持久化均已实现。
- UI 自动化：`swigridUITests` 覆盖 iPhone/iPad 核心冒烟。

### 2.2 最新验证结果

- `scripts/verify.sh` ✅
- `scripts/verify-xcode-backend.sh` ✅
- `scripts/verify-ios-app.sh` ✅
- `scripts/verify-ios-ui-tests.sh` ✅

## 3. 未完成项

1. 真机性能与稳定性基线。
2. 关键页面对照截图归档。
3. TestFlight 发布链路打通与演练。

## 4. 下一轮建议

1. 先做性能验证模板与首轮实测。
2. 再做发布链路脚本化。
3. 最后做发布前截图与 Go/No-Go 演练。

## 5. 更新模板（每轮追加）

```text
### [YYYY-MM-DD HH:mm] 轮次说明
- 完成：
- 文档更新：
- 验证命令与结果：
- 遗留问题/风险：
- 下一步：
```

## 6. 变更日志

### [2026-02-18 19:20] 文档体系重组

- 完成：将文档压缩为 4 份编号文档，重排职责与顺序。
- 文档更新：`docs/01~03`、`docs/README.md`、本文件。
- 验证命令与结果：文档结构变更，无代码行为变更。
- 遗留问题/风险：发布链路与真机性能仍未完成。
- 下一步：按 `03-执行与发布手册.md` 推进性能与发布准备。

### [2026-02-18 21:30] iOS 壳工程目录重组与可视化

- 完成：将壳工程入口迁移到 `ios-native/ios-app/swigrid/App/SwigridShellApp.swift`，资源迁移到 `ios-native/ios-app/swigrid/Resources/Assets.xcassets`；UI Test 文件重命名为 `SchulteGridUITests.swift` 并更新脚本测试选择器。
- 文档更新：新增 `ios-native/ios-app/README.md`；同步更新 `docs/02-架构与实现约束.md` 的目录结构描述。
- 验证命令与结果：`ios-native/scripts/verify-ios-app.sh` ✅（device/simulator build 成功）；`xcodebuild build-for-testing -project ios-native/ios-app/swigrid.xcodeproj -scheme swigrid -destination "platform=iOS Simulator,name=iPhone 17"` ✅（含 UI Test target 编译成功）。
- 遗留问题/风险：`verify-ios-ui-tests.sh` 在当前自动化会话中长时间无输出，需在本机 Xcode 再次手动确认 UI 用例执行结束状态。
- 下一步：在 Xcode 中打开 `ios-native/ios-app/swigrid.xcodeproj`，检查导航栏新增 `Sources/Tests/Package.swift` 可见性，并复跑 UI tests。

### [2026-02-18 22:10] 仓库扁平化重构（纯 iOS）

- 完成：将 `ios-native/` 下核心内容迁移到仓库根目录（`Package.swift`、`Sources/`、`Tests/`、`scripts/`、`swigrid.xcodeproj`、`swigrid/`、`swigridUITests/`），移除 `ios-native/` 目录层级。
- 文档更新：更新 `README.md`、`docs/02-架构与实现约束.md`、`docs/03-执行与发布手册.md`、本文件路径基线；CI 工作流迁移为 `.github/workflows/ios-ci.yml`。
- 验证命令与结果：`scripts/verify.sh` ✅；`scripts/verify-xcode-backend.sh` ✅；`scripts/verify-ios-app.sh` ✅；`xcodebuild build-for-testing -project swigrid.xcodeproj -scheme swigrid -destination "platform=iOS Simulator,name=iPhone 17"` ✅；`scripts/verify-ios-ui-tests.sh` ❌（`com.ujanw.swigridUITests.xctrunner` 启动被 Simulator 拒绝，日志：`.build-ios-ui-test/Logs/Test/Test-swigrid-2026.02.18_21-58-50-+0800.xcresult`）。
- 遗留问题/风险：UI Smoke Test 受当前 Simulator 运行态影响，需在本机 Xcode 测试面板复跑并确认进程启动稳定性。
- 下一步：在 Xcode 打开根目录 `swigrid.xcodeproj`，确认工程导航可直接查看 `swigrid/`、`Sources/`、`Tests/` 与 `swigridUITests/`。

### [2026-02-18 22:55] 功能还原一致性修复（按 docs/01 对齐）

- 完成：补齐玩家名规则与记录展示规则的防御性实现（玩家名统一裁剪到 16 字且去首尾空格；历史记录加载时归一化为升序+20 条上限；`fresh` 判定覆盖“完成当刻”边界）。
- 文档更新：本文件新增本轮记录。
- 验证命令与结果：`scripts/verify.sh` ✅；`scripts/verify-xcode-backend.sh` ✅；`scripts/verify-ios-app.sh` ✅。
- 遗留问题/风险：iOS 壳工程与 UI Test 仍需在本机 Xcode 环境复跑确认（延续上一轮风险）。
- 下一步：继续按 `docs/01` 对照 UI 文案与 About/Help 内容，完成剩余体验还原。

### [2026-02-18 23:30] UI 自动化稳定性修复与资源占用优化

- 完成：修复 `SchulteGridUITests` 选择器与同步时序问题（`records.list` 改为 `CollectionView` 查询；开始后等待 `game.next` 可点击）；`verify-ios-ui-tests.sh` 关闭并行测试并限制为 1 worker，避免额外 clone 模拟器占用资源。
- 文档更新：本文件新增本轮记录。
- 验证命令与结果：`scripts/verify-ios-ui-tests.sh` ✅（iPhone `testCoreFlowSavesRecord`、`testMutePersistsAfterRelaunch`，iPad `testCoreFlowSavesRecord` 全通过）。
- 遗留问题/风险：Xcode 仍可能在测试调度阶段短暂预热额外 clone 设备；已通过单 worker 显著降低持续占用。
- 下一步：继续按 `docs/01` 对照 UI 文案与 About/Help 内容，完成剩余体验还原。

### [2026-02-18 23:40] 文档可恢复性与方法原则固化

- 完成：补充“从零开始”恢复步骤与方法原则，确保下次可不依赖会话直接按文档推进。
- 文档更新：`docs/README.md`、`docs/02-架构与实现约束.md`、`docs/03-执行与发布手册.md`、本文件。
- 验证命令与结果：文档更新，无运行时行为变更。
- 遗留问题/风险：无新增代码风险。
- 下一步：按 `docs/04` 最新“下一步”继续对照 `docs/01` 做功能还原与细节收口。

### [2026-02-19 01:20] 用词与命名统一优化（不改变功能语义）

- 完成：统一 UI 文案表达（Home/Game/Records/About）、帮助与更新日志文案；重构核心命名（`ScoreRecord`/`ScoreRecords`/`ScoringRule` 等）并补充兼容别名，保持历史数据可解码。
- 文档更新：本文件新增本轮记录。
- 验证命令与结果：`scripts/verify.sh` ✅；`scripts/verify-ios-ui-tests.sh` ✅（iPhone `testCoreFlowSavesRecord`、`testMutePersistsAfterRelaunch`，iPad `testCoreFlowSavesRecord` 全通过）。
- 遗留问题/风险：无新增功能风险；仍待推进真机性能、截图归档与 TestFlight 发布链路。
- 下一步：继续按发布优先级推进性能基线、发布脚本化和发布前演练。
